#!/bin/bash

DEPLOYMENT_FILE="blue_deployment.yaml"
DEPLOYMENT_NAME="django-app-blue"
NAMESPACE="default"
SERVICE_URL="http://localhost:8000"
HEALTHCHECK_PATH="/health"  # Adjust based on your app

# Apply updated deployment to trigger rolling update
echo "Applying updated deployment with image version 2.0..."
kubectl apply -f $DEPLOYMENT_FILE

# Monitor the rollout status
echo "Waiting for rollout to complete..."
kubectl rollout status deployment/$DEPLOYMENT_NAME --namespace $NAMESPACE

# Test app availability during rollout
echo "Testing application availability for 60 seconds..."
END=$((SECONDS+60))
while [ $SECONDS -lt $END ]; do
  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $SERVICE_URL$HEALTHCHECK_PATH)
  TIMESTAMP=$(date +%T)
  if [ "$HTTP_CODE" -ne 200 ]; then
    echo "$TIMESTAMP - Warning: Received HTTP code $HTTP_CODE"
  else
    echo "$TIMESTAMP - Application is up (HTTP 200)"
  fi
  sleep 5
done

# Verify pods with updated image are running
echo "Verifying updated pods:"
kubectl get pods -l app=django-app,version=v1 --namespace $NAMESPACE -o jsonpath="{range .items[*]}{.metadata.name}: {.spec.containers[0].image}{'\n'}{end}"

echo "Rolling update complete."
